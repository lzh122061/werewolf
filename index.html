<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç‹¼äººçœŸè¨€ (iPadç‰ˆ)</title>
    <style>
        /* ================= Global Reset ================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0;
            width: 100vw;
            /* ä½¿ç”¨ dvh é€‚é… iPad/iOS æµè§ˆå™¨åœ°å€æ å˜åŒ– */
            height: 100vh; height: 100dvh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #fff;
            overflow: hidden;
            display: flex; flex-direction: column;
            background-color: #1a1b26;
            align-items: center; justify-content: center;
        }

        /* ğŸ“± APP ROOT - å…¨å±é€‚é… (å·²ç§»é™¤ PC é™åˆ¶) */
        #app-root {
            width: 100%; height: 100%;
            position: relative;
            background-color: transparent; 
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* èƒŒæ™¯å›¾ */
        #bg-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -2;
            opacity: 0.8;
        }
        #global-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: -1;
        }

        /* ================= Layout Sections ================= */
        .panel {
            display: none; width: 100%; height: 100%;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out;
            position: relative;
            z-index: 10;
        }
        .panel.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* iPad å¸ƒå±€æ¯”ä¾‹ä¼˜åŒ– */
        .top-area { 
            height: 15%; /* é¡¶éƒ¨ç•™ç™½ */
            display: flex; align-items: flex-end; justify-content: center; 
            flex-shrink: 0; 
        }
        .home-title {
            font-size: 48px; /* å­—ä½“åŠ å¤§ */
            font-weight: 900; color: #ffd700;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8); letter-spacing: 4px;
        }

        .middle-area { 
            flex: 1; /* å æ®ä¸­é—´ä¸»è¦ç©ºé—´ */
            display: flex; align-items: center; justify-content: center; 
            width: 100%; overflow: hidden; 
        }
        
        .bottom-area {
            height: 30%; /* åº•éƒ¨æ“ä½œåŒº */
            display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: max(40px, env(safe-area-inset-bottom));
            width: 85%; /* iPad å®½åº¦é€‚é… */
            max-width: 800px; /* æ”¾å®½é™åˆ¶ */
            margin: 0 auto; flex-shrink: 0;
        }

        /* ================= Components ================= */
        /* Avatar Grid (é¦–é¡µå¤´åƒ) - é€‚é… iPad */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px; /* é—´è·åŠ å¤§ */
            width: 85%; 
            max-width: 700px; /* æ‰©å¤§å®¹å™¨å®½åº¦ */
        }
        .role-item { display: flex; flex-direction: column; align-items: center; }
        .avatar-circle {
            width: 80px; height: 80px; /* å¤´åƒåŠ å¤§ */
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; margin-bottom: 8px;
            border: 3px solid transparent;
        }
        .avatar-icon { width: 100%; height: 100%; object-fit: cover; }
        .role-name { font-size: 16px; color: #ccc; font-weight: bold; }
        
        .role-item.active .avatar-circle { background: #4a506b; border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .role-item.active .role-name { color: #fff; }
        .role-item.inactive { opacity: 0.3; filter: grayscale(100%); transform: scale(0.9); }

        /* Settings UI - æ”¾å¤§ç‰ˆ */
        .info-text { 
            text-align: center; margin-bottom: 20px; 
            font-size: 18px; /* å­—ä½“åŠ å¤§ */
            color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.3); 
            padding: 5px 15px; border-radius: 15px; align-self: center; 
        }
        .settings-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 30px; }
        .setting-capsule {
            height: 60px; /* èƒ¶å›Šå¢é«˜ */
            background: rgba(60, 64, 85, 0.9); border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; /* å­—ä½“åŠ å¤§ */
            color: #eee; border: 1px solid rgba(255,255,255,0.1);
            flex: 1; user-select: none; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .player-counter { justify-content: space-between; padding: 0; background: rgba(44, 46, 62, 0.9); }
        .counter-btn { width: 60px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #ffd700; font-weight: bold; }
        .counter-num { font-weight: bold; }

        /* Buttons - æ”¾å¤§ç‰ˆ */
        .btn-main {
            width: auto; min-width: 300px; /* æŒ‰é’®åŠ å®½ */
            padding: 15px 50px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #3e2723; border-radius: 50px; font-weight: 900; font-size: 24px;
            border: none; box-shadow: 0 6px 15px rgba(255, 165, 0, 0.4);
            align-self: center; text-align: center;
            animation: pulse 2s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Common Panel Container */
        .panel-container {
            width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 40px; justify-content: center;
        }
        .panel-title { 
            font-size: 36px; font-weight: bold; color: #ffd700; 
            margin-bottom: 50px; text-shadow: 0 2px 5px rgba(0,0,0,0.8); text-align: center; 
        }
        
        /* Mayor Identity - æ”¾å¤§ */
        .mayor-avatar-large img { 
            width: 180px; height: 180px; /* æ”¾å¤§ */
            border-radius: 50%; border: 5px solid #ffd700; 
            margin-bottom: 60px; background: rgba(0,0,0,0.3); 
        }
        .identity-selector { display: flex; width: 100%; justify-content: space-around; max-width: 700px; }
        .id-btn { display: flex; flex-direction: column; align-items: center; opacity: 0.8; transition: 0.3s; cursor: pointer; }
        .id-btn.selected { opacity: 1; transform: scale(1.15); }
        .id-btn img { 
            width: 100px; height: 100px; /* æ”¾å¤§ */
            border-radius: 50%; margin-bottom: 15px; 
            background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); 
        }
        .id-btn span { font-size: 20px; color: #fff; font-weight: bold; }
        .id-btn.selected img { border-color: #ffd700; box-shadow: 0 0 20px #ffd700; }

        /* Word Pick (Waterfall) - iPad ä¼˜åŒ– */
        .word-card-list {
            width: 90%; max-width: 700px; /* å®½åº¦æ”¾å®½ */
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            padding-bottom: 100px; overflow-y: auto;
        }
        .word-card {
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.8);
            padding: 25px 20px; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 120px; cursor: pointer; transition: 0.2s;
        }
        .card-selected { background: #FFD700 !important; border-color: #FFD700 !important; transform: scale(1.02); box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4); }
        .card-selected .card-text, .card-selected .card-category { color: #3e2723; text-shadow: none; }
        .card-text { font-size: 28px; font-weight: bold; color: #fff; text-align: center; margin-bottom: 8px; }
        .card-category { font-size: 16px; color: #aaa; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 6px; }

        /* Night Mode & Tabletop - è´´è¾¹é€‚é… */
        .night-status {
            font-size: 60px; font-weight: 900; color: #ffd700; text-align: center;
            letter-spacing: 5px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            animation: breathe 3s infinite;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        
        .tabletop-view { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; }
        .night-word-box {
            position: absolute; top: 50%;
            display: flex; align-items: center; justify-content: center;
            white-space: nowrap;
            /* ç§»é™¤èƒŒæ™¯æ¡†ï¼Œçº¯æ–‡å­— */
        }
        .target-word {
            font-size: 80px; font-weight: 900; color: #FFD700; letter-spacing: 5px;
            text-shadow: 3px 3px 15px rgba(0,0,0,1); line-height: 1.2;
            transition: opacity 2s ease-out;
        }
        /* è´´è¿‘å±å¹•è¾¹ç¼˜ (30px) */
        .normal-view { left: 30px; transform: translateY(-50%) rotate(-90deg); transform-origin: center; }
        .rotated-view { right: 30px; transform: translateY(-50%) rotate(90deg); transform-origin: center; }

        /* Game Timer - æ”¾å¤§ */
        .timer-display { 
            font-size: 120px; /* å·¨å¤§ */
            font-weight: bold; color: #fff; font-family: monospace; 
            text-shadow: 0 0 20px rgba(0,0,0,0.5); margin-bottom: 30px; 
        }
        .btn-word-guessed {
            width: auto; min-width: 350px; padding: 15px 50px;
            background: #f0c040; color: #3e2723; font-weight: bold; font-size: 24px;
            border-radius: 40px; border: none; cursor: pointer; white-space: nowrap;
            box-shadow: 0 5px 15px rgba(240, 192, 64, 0.4);
        }

        /* Result - æ”¾å¤§ */
        .result-avatars { display: flex; width: 100%; justify-content: space-around; max-width: 700px; flex: 1; align-items: center; }
        .winner-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
        .winner-circle {
            width: 120px; height: 120px; /* æ”¾å¤§ */
            border-radius: 50%; margin-bottom: 15px;
            border: 4px solid rgba(255,255,255,0.3); overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .winner-circle img { width: 100%; height: 100%; }
        .winner-item span { font-size: 24px; color: #ccc; font-weight: bold; } /* å­—ä½“åŠ å¤§ */
        .winner-item.selected { transform: scale(1.15); }
        .winner-item.selected .winner-circle { border-color: #ffd700; box-shadow: 0 0 30px rgba(255,215,0,0.8); }
        .winner-item.selected span { color: #ffd700; }
        
        .btn-back-home {
            width: auto; min-width: 300px; padding: 15px 50px;
            background: rgba(74, 144, 226, 0.3); border: 2px solid #4a90e2; color: #aaccff;
            font-weight: bold; font-size: 22px; border-radius: 40px; cursor: pointer;
        }

        /* Bottom Control Bar - æ‚¬æµ®å›ºå®š */
        .game-bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 20px 40px; 
            padding-bottom: max(30px, env(safe-area-inset-bottom));
            display: flex; justify-content: space-between; z-index: 100;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }
        .control-icon { width: 60px; height: 60px; cursor: pointer; opacity: 0.8; } /* å›¾æ ‡åŠ å¤§ */
        .control-icon:active { transform: scale(0.9); opacity: 1; }

        /* Modal */
        .modal-mask {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999; align-items: center; justify-content: center;
        }
        .modal-mask.show { display: flex; }
        .modal-content {
            width: 70%; max-width: 400px; background: rgba(37, 24, 56, 0.95);
            border: 3px solid #FFD700; border-radius: 16px; padding: 30px; text-align: center;
        }
        .modal-title { font-size: 28px; font-weight: bold; color: #fff; margin-bottom: 20px; }
        .modal-body { font-size: 20px; color: #ddd; margin-bottom: 30px; }
        .modal-footer { display: flex; justify-content: space-around; margin-top: 20px; }
        .modal-btn { padding: 12px 30px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; font-size: 18px; }
        .modal-btn.cancel { background: transparent; border: 2px solid #666; color: #aaa; }
        .modal-btn.confirm { background: #FFD700; color: #3e2723; }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
<!-- ğŸ“± APP ROOT -->
<div id="app-root">

    <!-- Layer 0: Background (ä¿®å¤: ä½¿ç”¨ç›¸å¯¹è·¯å¾„) -->
    <img id="bg-image" src="./images/bg.png" alt="background">
    <div id="global-mask"></div>

    <!-- Panel 0: SETUP -->
    <div id="panel-setup" class="panel active">
        <div class="top-area">
            <div class="home-title">ç‹¼äººçœŸè¨€</div>
        </div>
        <div class="middle-area">
            <div class="avatar-grid" id="setup-grid">
                <!-- JS will inject avatars here -->
            </div>
        </div>
        <div class="bottom-area">
            <div class="info-text" id="config-summary">é…ç½®åŠ è½½ä¸­...</div>
            <div class="settings-row">
                <div class="setting-capsule player-counter">
                    <div class="counter-btn" onclick="app.changeCount(-1)">-</div>
                    <div class="counter-num" id="player-count">4äºº</div>
                    <div class="counter-btn" onclick="app.changeCount(1)">+</div>
                </div>
                <div class="setting-capsule" onclick="app.toggleDifficulty()">
                    <span id="difficulty-text">è¯æ±‡: æ™®é€š</span>
                </div>
                <div class="setting-capsule" onclick="app.toggleTimer()">
                    <span id="timer-text">æ—¶é—´: 5åˆ†</span>
                </div>
            </div>
            <div style="display: flex; justify-content: center;">
                <button class="btn-main" onclick="app.startGame()">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>
    </div>

    <!-- Panel 0.5: SAFETY BUFFER -->
    <div id="panel-buffer" class="panel">
        <div class="panel-container">
            <div class="night-status">å¤©é»‘è¯·é—­çœ¼...</div>
        </div>
    </div>

    <!-- Panel 1: MAYOR ID -->
    <div id="panel-mayor-id" class="panel">
        <div class="panel-container" style="justify-content: center;">
            <div class="panel-title">è¯·æ‘é•¿é€‰æ‹©ä½ çš„èº«ä»½</div>
            <div class="mayor-avatar-large">
                <img src="./images/cz.png">
            </div>
            <div class="identity-selector">
                <div class="id-btn" onclick="app.selectIdentity('seer', this)">
                    <img src="./images/seer.png"><span>å…ˆçŸ¥</span>
                </div>
                <div class="id-btn" onclick="app.selectIdentity('wolf', this)">
                    <img src="./images/wolf.png"><span>ç‹¼äºº</span>
                </div>
                <div class="id-btn" onclick="app.selectIdentity('villager', this)">
                    <img src="./images/villager.png"><span>æ‘æ°‘</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel 2: MAYOR PICK -->
    <div id="panel-mayor-pick" class="panel">
        <div class="panel-container" style="justify-content: flex-start; padding-top: 15vh;">
            <div class="panel-title" style="font-size: 32px;">è¯·æ‘é•¿é€‰æ‹©è¯è¯­</div>
            <div class="word-card-list" id="word-list">
                <!-- JS injected -->
            </div>
        </div>
        <!-- Bottom Bar injected dynamically or shared -->
    </div>

    <!-- Panel 3: NIGHT -->
    <div id="panel-night" class="panel">
        <div class="panel-container">
            <div class="night-status" id="night-status-text"></div>
            <div class="tabletop-view" id="night-word-container" style="display: none;">
                <div class="night-word-box normal-view"><span class="target-word"></span></div>
                <div class="night-word-box rotated-view"><span class="target-word"></span></div>
            </div>
        </div>
    </div>

    <!-- Panel 4: GAME -->
    <div id="panel-game" class="panel">
        <div class="panel-container" style="justify-content: space-between; padding-bottom: 15vh;">
            <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <div class="timer-display" id="timer-display">05:00</div>
                <button class="btn-word-guessed" onclick="app.onWordGuessed()">è¯è¯­å·²çŒœå‡º</button>
            </div>
        </div>
    </div>

    <!-- Panel 5: RESULT -->
    <div id="panel-result" class="panel">
        <div class="panel-container" style="justify-content: space-between; padding-top: 10vh; padding-bottom: 10vh;">
            <div class="panel-title" style="font-size: 36px;">è¯·é€‰æ‹©èƒœåˆ©æ–¹</div>
            <div class="result-avatars">
                <div class="winner-item" onclick="app.selectWinner('wolf', this)">
                    <div class="winner-circle" style="background:#e04f5f"><img src="./images/wolf.png"></div><span>ç‹¼äºº</span>
                </div>
                <div class="winner-item" onclick="app.selectWinner('seer', this)">
                    <div class="winner-circle" style="background:#9b59b6"><img src="./images/seer.png"></div><span>å…ˆçŸ¥</span>
                </div>
                <div class="winner-item" onclick="app.selectWinner('villager', this)">
                    <div class="winner-circle" style="background:#f0c040"><img src="./images/villager.png"></div><span>æ‘æ°‘</span>
                </div>
            </div>
            <button class="btn-back-home" onclick="app.resetGame()">è¿”å›é¦–é¡µ</button>
        </div>
    </div>

    <!-- Shared Bottom Control -->
    <div id="game-bottom-bar" class="game-bottom-bar" style="display: none;">
        <img class="control-icon" src="./images/icon_pause.png" onclick="app.pauseGame()">
        <img class="control-icon" src="./images/icon_stop.png" onclick="app.exitGame()">
    </div>

    <!-- Modal -->
    <div id="modal-mask" class="modal-mask">
        <div class="modal-content">
            <div class="modal-title" id="modal-title">æ ‡é¢˜</div>
            <div class="modal-body" id="modal-body">å†…å®¹</div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="app.closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="modal-confirm-btn">ç¡®å®š</button>
            </div>
        </div>
    </div>

</div>

<!-- å¼•å…¥å¤–éƒ¨è¯åº“ -->
<script src="words.js"></script>

<script>
// -----------------------------------------------------------
// ä»¥ä¸‹æ˜¯æ¸¸æˆé€»è¾‘ä»£ç 
// -----------------------------------------------------------

const ROLE_CONFIG = {
    4: { seer: 1, wolf: 1, villager: 2 },
    5: { seer: 1, wolf: 1, villager: 3 },
    6: { seer: 1, wolf: 1, villager: 4 },
    7: { seer: 1, wolf: 2, villager: 4 },
    8: { seer: 1, wolf: 2, villager: 5 },
    9: { seer: 1, wolf: 2, villager: 6 },
    10: { seer: 1, wolf: 2, villager: 7 }
};

const FIXED_SLOTS_DEF = [
  { type: 'seer', name: 'å…ˆçŸ¥', img: './images/seer.png' },
  { type: 'wolf', name: 'ç‹¼äºº', img: './images/wolf.png' },
  { type: 'wolf', name: 'ç‹¼äºº', img: './images/wolf.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' },
  { type: 'villager', name: 'æ‘æ°‘', img: './images/villager.png' }
];

const DIFFICULTY_OPTS = [
    { label: "ç®€å•", key: "SIMPLE" }, { label: "æ™®é€š", key: "NORMAL" },
    { label: "ä¸­ç­‰", key: "MEDIUM" }, { label: "å›°éš¾", key: "HARD" }, { label: "åœ°ç‹±", key: "HELL" }
];
const TIMER_OPTS = [4, 5, 6, 7, 8];

const AudioController = {
    ctx: {},
    currentAudio: null, // Track currently playing audio for interrupt
    init: function() {
        const files = ['click', 'paper', 'pop', 'night_start', 'mayor_identity', 'mayor_pick', 'seer_open', 'seer_close', 'wolf_open', 'wolf_close', 'day_break', 'sfx_tick_tock', 'voice_assassinate', 'sfx_win_werewolf', 'sfx_win_seer', 'sfx_win_villager', 'game_resume'];
        files.forEach(f => {
            this.ctx[f] = new Audio(`./audio/${f}.mp3`);
            if(f === 'sfx_tick_tock') this.ctx[f].loop = true;
        });
    },
    play: function(name) {
        if (!this.ctx[name]) return;
        
        // Interrupt logic
        if (this.currentAudio && this.currentAudio !== this.ctx[name] && name !== 'sfx_tick_tock') {
            this.currentAudio.pause();
            this.currentAudio.currentTime = 0;
        }

        this.ctx[name].currentTime = 0;
        this.ctx[name].volume = 1;
        this.ctx[name].play().catch(e => console.log("Audio needed interaction:", e));
        
        if (name !== 'sfx_tick_tock') {
            this.currentAudio = this.ctx[name];
        }
        if (navigator.vibrate) navigator.vibrate(50);
    },
    stop: function(name) {
        if (!this.ctx[name]) return;
        this.ctx[name].pause();
        this.ctx[name].currentTime = 0;
    },
    fadeOutTick: function() {
        const audio = this.ctx['sfx_tick_tock'];
        audio.volume = 1;
        audio.play();
        let vol = 1;
        let fade = setInterval(() => {
            vol -= 0.05;
            if (vol <= 0) {
                vol = 0; clearInterval(fade); audio.pause();
            }
            audio.volume = vol;
        }, 250);
    }
};

const App = {
    state: {
        playerCount: 4,
        difficultyIdx: 1,
        timerIdx: 1,
        gameDuration: 300,
        candidates: [],
        targetWord: '',
        timer: null,
        paused: false
    },

    init: function() {
        AudioController.init();
        this.renderSetup();
    },

    changeCount: function(delta) {
        let n = this.state.playerCount + delta;
        if (n >= 4 && n <= 10) {
            this.state.playerCount = n;
            AudioController.play('click');
            this.renderSetup();
        }
    },
    toggleDifficulty: function() {
        this.state.difficultyIdx = (this.state.difficultyIdx + 1) % DIFFICULTY_OPTS.length;
        AudioController.play('paper');
        this.renderSetup();
    },
    toggleTimer: function() {
        this.state.timerIdx = (this.state.timerIdx + 1) % TIMER_OPTS.length;
        AudioController.play('pop');
        this.renderSetup();
    },

    renderSetup: function() {
        document.getElementById('player-count').innerText = this.state.playerCount + 'äºº';
        document.getElementById('difficulty-text').innerText = 'è¯æ±‡: ' + DIFFICULTY_OPTS[this.state.difficultyIdx].label;
        document.getElementById('timer-text').innerText = 'æ—¶é—´: ' + TIMER_OPTS[this.state.timerIdx] + 'åˆ†';
        
        const config = ROLE_CONFIG[this.state.playerCount];
        
        let currentCounts = { seer: 0, wolf: 0, villager: 0 };
        let html = '';
        
        FIXED_SLOTS_DEF.forEach((slot) => {
            const roleType = slot.type;
            const maxAllowed = config[roleType] || 0;
            
            let isActive = false;
            if (currentCounts[roleType] < maxAllowed) {
                isActive = true;
                currentCounts[roleType]++;
            }
            
            const activeClass = isActive ? 'active' : 'inactive';
            
            html += `<div class="role-item ${activeClass}">
                <div class="avatar-circle"><img class="avatar-icon" src="${slot.img}"></div>
                <div class="role-name">${slot.name}</div>
            </div>`;
        });
        
        document.getElementById('setup-grid').innerHTML = html;
        document.getElementById('config-summary').innerText = `å…ˆçŸ¥${config.seer} ç‹¼äºº${config.wolf} æ‘æ°‘${config.villager}`;
    },

    switchPanel: function(panelId) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(panelId).classList.add('active');
        const bar = document.getElementById('game-bottom-bar');
        bar.style.display = (panelId === 'panel-mayor-pick' || panelId === 'panel-game') ? 'flex' : 'none';
    },

    startGame: function() {
        const key = DIFFICULTY_OPTS[this.state.difficultyIdx].key;
        if(typeof WORD_BANK === 'undefined') { alert("è¯åº“æœªåŠ è½½! æ£€æŸ¥words.js"); return; }
        const pool = WORD_BANK[key] || WORD_BANK['NORMAL'];
        const shuffled = [...pool].sort(() => 0.5 - Math.random());
        this.state.candidates = shuffled.slice(0, 6);
        this.state.gameDuration = TIMER_OPTS[this.state.timerIdx] * 60;
        
        this.switchPanel('panel-buffer');
        AudioController.play('night_start');
        setTimeout(() => {
            this.switchPanel('panel-mayor-id');
            AudioController.play('mayor_identity');
        }, 5000);
    },

    selectIdentity: function(type, el) {
        document.querySelectorAll('.id-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        setTimeout(() => {
            this.renderWordPick();
            this.switchPanel('panel-mayor-pick');
            AudioController.play('mayor_pick');
        }, 500);
    },

    renderWordPick: function() {
        let html = '';
        this.state.candidates.forEach((w, idx) => {
            html += `<div class="word-card" onclick="app.pickWord(${idx}, this)">
                <div class="card-text">${w.word}</div>
                <div class="card-category">${w.category}</div>
            </div>`;
        });
        document.getElementById('word-list').innerHTML = html;
    },

    pickWord: function(idx, el) {
        this.state.targetWord = this.state.candidates[idx].word;
        document.querySelectorAll('.word-card').forEach(b => b.classList.remove('card-selected'));
        el.classList.add('card-selected');
        setTimeout(() => { this.runNightSequence(); }, 500);
    },

    async runNightSequence() {
        this.switchPanel('panel-night');
        
        const setStatus = (txt) => {
            document.getElementById('night-status-text').style.display = 'block';
            document.getElementById('night-word-container').style.display = 'none';
            document.getElementById('night-status-text').innerText = txt;
        };
        
        const setWord = () => {
            document.getElementById('night-status-text').style.display = 'none';
            document.getElementById('night-word-container').style.display = 'block';
            document.querySelectorAll('.target-word').forEach(e => {
                // Fix: reset transition and opacity immediately
                e.style.transition = 'none';
                e.style.opacity = '1';
                e.innerText = this.state.targetWord;
            });
        };
        
        const fadeOut = () => {
            document.querySelectorAll('.target-word').forEach(e => {
                e.style.transition = 'opacity 2s ease-out';
                // Trigger reflow
                void e.offsetWidth;
                e.style.opacity = '0';
            });
        };
        
        const wait = (ms) => new Promise(r => setTimeout(r, ms));

        try {
            setStatus("å…ˆçŸ¥è¯·ççœ¼"); AudioController.play('seer_open'); await wait(2500);
            setWord(); await wait(7000); 
            fadeOut(); await wait(2000);
            
            setStatus("å…ˆçŸ¥è¯·é—­çœ¼"); AudioController.play('seer_close'); await wait(3000);

            setStatus("ç‹¼äººè¯·ççœ¼"); AudioController.play('wolf_open'); await wait(2500);
            // å†æ¬¡è°ƒç”¨ setWord ä¼šé‡ç½® opacity ä¸º 1
            setWord(); await wait(7000);
            fadeOut(); await wait(2000);

            setStatus("ç‹¼äººè¯·é—­çœ¼"); AudioController.play('wolf_close'); await wait(3000);

            setStatus("å¤©äº®äº†ï¼"); AudioController.play('day_break'); await wait(2000);
            
            this.startMainGame();
        } catch(e) {
            console.error(e);
        }
    },

    startMainGame: function() {
        this.switchPanel('panel-game');
        AudioController.fadeOutTick();
        this.state.paused = false;
        this.updateTimerDisplay();
        
        if (this.state.timer) clearInterval(this.state.timer);
        this.state.timer = setInterval(() => {
            if(!this.state.paused) {
                this.state.gameDuration--;
                this.updateTimerDisplay();
                if(this.state.gameDuration <= 0) {
                    clearInterval(this.state.timer);
                    this.onGameOver();
                }
            }
        }, 1000);
    },

    updateTimerDisplay: function() {
        let m = Math.floor(this.state.gameDuration / 60).toString().padStart(2, '0');
        let s = (this.state.gameDuration % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    },

    onWordGuessed: function() {
        clearInterval(this.state.timer);
        AudioController.stop('sfx_tick_tock');
        AudioController.play('voice_assassinate');
        setTimeout(() => this.switchPanel('panel-result'), 2000);
    },

    onGameOver: function() {
        clearInterval(this.state.timer);
        AudioController.stop('sfx_tick_tock');
        this.switchPanel('panel-result');
    },

    selectWinner: function(type, el) {
        document.querySelectorAll('.winner-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        let sound = `sfx_win_${type}`;
        if(type === 'wolf') sound = 'sfx_win_werewolf';
        AudioController.play(sound);
    },

    resetGame: function() {
        clearInterval(this.state.timer);
        AudioController.stop('sfx_tick_tock');
        this.switchPanel('panel-setup');
    },
    
    pauseGame: function() {
        this.state.paused = true;
        AudioController.stop('sfx_tick_tock');
        this.showModal('æ¸¸æˆå·²æš‚åœ', 'ç‚¹å‡»ç¡®å®šç»§ç»­æ¸¸æˆ', 'PAUSE');
    },
    exitGame: function() {
        this.showModal('ç»“æŸæ¸¸æˆ', 'ç¡®å®šè¦å¼ºåˆ¶ç»“æŸå¹¶è¿”å›é¦–é¡µå—ï¼Ÿ', 'EXIT');
    },
    showModal: function(title, content, type) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerText = content;
        document.getElementById('modal-mask').classList.add('show');
        document.getElementById('modal-confirm-btn').onclick = () => {
            document.getElementById('modal-mask').classList.remove('show');
            if(type === 'PAUSE') {
                this.state.paused = false;
                AudioController.play('game_resume');
                // Resume tick if in early game
                if(this.state.gameDuration > 0) {
                     // Optionally restart tick sound or just let logic handle
                     // For simplicity we just resume logic
                }
            } else if (type === 'EXIT') {
                this.resetGame();
            }
        };
    },
    closeModal: function() { document.getElementById('modal-mask').classList.remove('show'); }
};

window.app = App;
window.onload = function() {
    App.init();
};
</script>
</body>
</html>