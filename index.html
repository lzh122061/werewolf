<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Áãº‰∫∫ÁúüË®Ä (iPad ProÁâà)</title>
    <style>
        /* ================= Global Reset ================= */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            margin: 0; padding: 0;
            width: 100vw;
            height: 100vh; height: 100dvh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #fff;
            overflow: hidden;
            display: flex; flex-direction: column;
            background-color: #1a1b26;
            align-items: center; justify-content: center;
        }

        #app-root {
            width: 100%; height: 100%;
            position: relative;
            background-color: transparent; 
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        #bg-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; opacity: 1;
        }
        #global-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 2;
        }

        /* ================= Panels ================= */
        .panel {
            display: none; width: 100%; height: 100%;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out;
            position: relative; z-index: 10;
        }
        .panel.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .top-area { height: 15%; display: flex; align-items: flex-end; justify-content: center; flex-shrink: 0; }
        .home-title { font-size: 56px; font-weight: 900; color: #ffd700; text-shadow: 0 4px 10px rgba(0,0,0,0.8); letter-spacing: 6px; }

        .middle-area { flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; overflow: hidden; }
        
        .bottom-area {
            height: 30%; display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: max(60px, env(safe-area-inset-bottom));
            width: 85%; max-width: 900px; margin: 0 auto; flex-shrink: 0;
        }

        /* Avatar Grid */
        .avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 25px; width: 90%; max-width: 850px; }
        .role-item { display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; }
        .avatar-circle {
            width: 90px; height: 90px; border-radius: 50%; background: rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 10px; border: 3px solid transparent;
        }
        .avatar-icon { width: 100%; height: 100%; object-fit: cover; }
        .role-name { font-size: 18px; color: #ccc; font-weight: bold; }
        .role-item.active .avatar-circle { background: #4a506b; border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        .role-item.active .role-name { color: #fff; }
        .role-item.inactive { opacity: 0.3; filter: grayscale(100%); transform: scale(0.9); }

        /* Settings */
        .info-text { text-align: center; margin-bottom: 25px; font-size: 20px; color: rgba(255,255,255,0.8); background: rgba(0,0,0,0.4); padding: 8px 20px; border-radius: 20px; align-self: center; }
        .settings-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 40px; }
        .setting-capsule {
            height: 70px; background: rgba(60, 64, 85, 0.9); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; color: #eee; border: 1px solid rgba(255,255,255,0.1);
            flex: 1; user-select: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .player-counter { justify-content: space-between; padding: 0; background: rgba(44, 46, 62, 0.9); }
        .counter-btn { width: 70px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 36px; color: #ffd700; font-weight: bold; }
        .counter-num { font-weight: bold; font-size: 26px; }

        .btn-main {
            width: auto; min-width: 350px; padding: 20px 60px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #3e2723; border-radius: 60px; font-weight: 900; font-size: 28px;
            border: none; box-shadow: 0 8px 20px rgba(255, 165, 0, 0.5);
            align-self: center; text-align: center; animation: pulse 2s infinite; cursor: pointer;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* Panels */
        .panel-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 40px; justify-content: center; }
        .panel-title { font-size: 36px; font-weight: bold; color: #ffd700; margin-bottom: 50px; text-shadow: 0 2px 5px rgba(0,0,0,0.8); text-align: center; }
        
        .mayor-avatar-large img { width: 180px; height: 180px; border-radius: 50%; border: 5px solid #ffd700; margin-bottom: 60px; background: rgba(0,0,0,0.3); }
        .identity-selector { display: flex; width: 100%; justify-content: space-around; max-width: 700px; }
        .id-btn { display: flex; flex-direction: column; align-items: center; opacity: 0.8; transition: 0.3s; cursor: pointer; }
        .id-btn.selected { opacity: 1; transform: scale(1.15); }
        .id-btn img { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); }
        .id-btn span { font-size: 20px; color: #fff; font-weight: bold; }
        .id-btn.selected img { border-color: #ffd700; box-shadow: 0 0 20px #ffd700; }

        /* Word Pick */
        .word-card-list {
            width: 90%; max-width: 800px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            padding-bottom: 120px; overflow-y: auto;
        }
        .word-card {
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.8);
            padding: 25px 20px; border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 120px; cursor: pointer; transition: 0.2s;
        }
        .card-selected { background: #FFD700 !important; border-color: #FFD700 !important; transform: scale(1.02); box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4); }
        .card-selected .card-text, .card-selected .card-category { color: #3e2723; text-shadow: none; }
        .card-text { font-size: 28px; font-weight: bold; color: #fff; text-align: center; margin-bottom: 8px; }
        .card-category { font-size: 16px; color: #aaa; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 6px; }

        /* Night Mode */
        .night-status {
            font-size: 70px; font-weight: 900; color: #ffd700; text-align: center;
            letter-spacing: 5px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            animation: breathe 3s infinite;
        }
        @keyframes breathe { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        
        .tabletop-view { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; }
        .night-word-box {
            position: absolute; top: 50%; display: flex; align-items: center; justify-content: center; white-space: nowrap;
        }
        .target-word {
            font-size: 110px; font-weight: 900; color: #FFD700; letter-spacing: 8px;
            text-shadow: 4px 4px 20px rgba(0,0,0,1); line-height: 1.2;
            opacity: 0; transition: opacity 0.3s ease-in;
        }
        .normal-view { left: 50px; transform: translateY(-50%) rotate(-90deg); transform-origin: center; }
        .rotated-view { right: 50px; transform: translateY(-50%) rotate(90deg); transform-origin: center; }

        /* Game & Timer */
        .timer-display { font-size: 160px; font-weight: bold; color: #fff; font-family: monospace; text-shadow: 0 0 30px rgba(0,0,0,0.5); margin-bottom: 40px; }
        .btn-word-guessed {
            width: auto; min-width: 400px; padding: 20px 50px;
            background: #f0c040; color: #3e2723; font-weight: 900; font-size: 32px;
            border-radius: 50px; border: none; cursor: pointer; white-space: nowrap;
            box-shadow: 0 8px 20px rgba(240, 192, 64, 0.5);
        }

        /* Result */
        .result-avatars { display: flex; width: 100%; justify-content: space-around; max-width: 800px; flex: 1; align-items: center; }
        .winner-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
        .winner-circle {
            width: 140px; height: 140px; border-radius: 50%; margin-bottom: 20px;
            border: 5px solid rgba(255,255,255,0.3); overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .winner-circle img { width: 100%; height: 100%; }
        .winner-item span { font-size: 28px; color: #ccc; font-weight: bold; }
        .winner-item.selected { transform: scale(1.15); }
        .winner-item.selected .winner-circle { border-color: #ffd700; box-shadow: 0 0 35px rgba(255,215,0,0.8); }
        .winner-item.selected span { color: #ffd700; }
        
        .btn-back-home {
            width: auto; min-width: 350px; padding: 18px 50px;
            background: rgba(74, 144, 226, 0.3); border: 3px solid #4a90e2; color: #aaccff;
            font-weight: bold; font-size: 26px; border-radius: 50px; cursor: pointer;
        }

        /* Bottom Control Bar */
        .game-bottom-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px 60px; padding-bottom: max(40px, env(safe-area-inset-bottom));
            display: flex; justify-content: space-between; z-index: 100;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }
        .control-icon { width: 70px; height: 70px; cursor: pointer; opacity: 0.8; }
        .control-icon:active { transform: scale(0.9); opacity: 1; }

        /* Modal */
        .modal-mask {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 999; align-items: center; justify-content: center;
        }
        .modal-mask.show { display: flex; }
        .modal-content {
            width: 70%; max-width: 500px; background: rgba(37, 24, 56, 0.95);
            border: 4px solid #FFD700; border-radius: 20px; padding: 40px; text-align: center;
        }
        .modal-title { font-size: 32px; font-weight: bold; color: #fff; margin-bottom: 25px; }
        .modal-body { font-size: 24px; color: #ddd; margin-bottom: 40px; }
        .modal-footer { display: flex; justify-content: space-around; margin-top: 20px; }
        .modal-btn { padding: 15px 40px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; font-size: 20px; }
        .modal-btn.cancel { background: transparent; border: 2px solid #666; color: #aaa; }
        .modal-btn.confirm { background: #FFD700; color: #3e2723; }

        /* Hide Scrollbar */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
<!-- üì± APP ROOT -->
<div id="app-root">

    <!-- Layer 0: Background (‰øÆÂ§ç: ‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑ) -->
    <img id="bg-image" src="images/bg.png" alt="background">
    <div id="global-mask"></div>

    <!-- Panel 0: SETUP -->
    <div id="panel-setup" class="panel active">
        <div class="top-area">
            <div class="home-title"></div>
        </div>
        <div class="middle-area">
            <div class="avatar-grid" id="setup-grid">
                <!-- JS will inject avatars here -->
            </div>
        </div>
        <div class="bottom-area">
            <div class="info-text" id="config-summary">ÈÖçÁΩÆÂä†ËΩΩ‰∏≠...</div>
            <div class="settings-row">
                <div class="setting-capsule player-counter">
                    <div class="counter-btn" onclick="app.changeCount(-1)">-</div>
                    <div class="counter-num" id="player-count">4‰∫∫</div>
                    <div class="counter-btn" onclick="app.changeCount(1)">+</div>
                </div>
                <div class="setting-capsule" onclick="app.toggleDifficulty()">
                    <span id="difficulty-text">ËØçÊ±á: ÊôÆÈÄö</span>
                </div>
                <div class="setting-capsule" onclick="app.toggleTimer()">
                    <span id="timer-text">Êó∂Èó¥: 5ÂàÜ</span>
                </div>
            </div>
            <div style="display: flex; justify-content: center;">
                <button class="btn-main" onclick="app.startGame()">ÂºÄÂßãÊ∏∏Êàè</button>
            </div>
        </div>
    </div>

    <!-- Panel 0.5: SAFETY BUFFER -->
    <div id="panel-buffer" class="panel">
        <div class="panel-container">
            <div class="night-status">Â§©ÈªëËØ∑Èó≠Áúº...</div>
        </div>
    </div>

    <!-- Panel 1: MAYOR ID -->
    <div id="panel-mayor-id" class="panel">
        <div class="panel-container" style="justify-content: center;">
            <div class="panel-title">ËØ∑ÊùëÈïøÈÄâÊã©‰Ω†ÁöÑË∫´‰ªΩ</div>
            <div class="mayor-avatar-large">
                <img src="./images/cz.png">
            </div>
            <div class="identity-selector">
                <div class="id-btn" onclick="app.selectIdentity('seer', this)">
                    <img src="./images/seer.png"><span>ÂÖàÁü•</span>
                </div>
                <div class="id-btn" onclick="app.selectIdentity('wolf', this)">
                    <img src="./images/wolf.png"><span>Áãº‰∫∫</span>
                </div>
                <div class="id-btn" onclick="app.selectIdentity('villager', this)">
                    <img src="./images/villager.png"><span>ÊùëÊ∞ë</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel 2: MAYOR PICK -->
    <div id="panel-mayor-pick" class="panel">
        <div class="panel-container" style="justify-content: flex-start; padding-top: 15vh;">
            <div class="panel-title" style="font-size: 32px;">ËØ∑ÊùëÈïøÈÄâÊã©ËØçËØ≠</div>
            <div class="word-card-list" id="word-list">
                <!-- JS injected -->
            </div>
        </div>
        <!-- Bottom Bar injected dynamically or shared -->
    </div>

    <!-- Panel 3: NIGHT -->
    <div id="panel-night" class="panel">
        <div class="panel-container">
            <div class="night-status" id="night-status-text"></div>
            <div class="tabletop-view" id="night-word-container" style="display: none;">
                <div class="night-word-box normal-view"><span class="target-word"></span></div>
                <div class="night-word-box rotated-view"><span class="target-word"></span></div>
            </div>
        </div>
    </div>

    <!-- Panel 4: GAME -->
    <div id="panel-game" class="panel">
        <div class="panel-container" style="justify-content: space-between; padding-bottom: 15vh;">
            <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <div class="timer-display" id="timer-display">05:00</div>
                <button class="btn-word-guessed" onclick="app.onWordGuessed()">ËØçËØ≠Â∑≤ÁåúÂá∫</button>
            </div>
        </div>
    </div>

    <!-- Panel 5: RESULT -->
    <div id="panel-result" class="panel">
        <div class="panel-container" style="justify-content: space-between; padding-top: 10vh; padding-bottom: 10vh;">
            <div class="panel-title" style="font-size: 36px;">ËØ∑ÈÄâÊã©ËÉúÂà©Êñπ</div>
            <div class="result-avatars">
                <div class="winner-item" onclick="app.selectWinner('wolf', this)">
                    <div class="winner-circle" style="background:#e04f5f"><img src="images/wolf.png"></div><span>Áãº‰∫∫</span>
                </div>
                <div class="winner-item" onclick="app.selectWinner('seer', this)">
                    <div class="winner-circle" style="background:#9b59b6"><img src="images/seer.png"></div><span>ÂÖàÁü•</span>
                </div>
                <div class="winner-item" onclick="app.selectWinner('villager', this)">
                    <div class="winner-circle" style="background:#f0c040"><img src="images/villager.png"></div><span>ÊùëÊ∞ë</span>
                </div>
            </div>
            <button class="btn-back-home" onclick="app.resetGame()">ËøîÂõûÈ¶ñÈ°µ</button>
        </div>
    </div>

    <!-- Shared Bottom Control -->
    <div id="game-bottom-bar" class="game-bottom-bar" style="display: none;">
        <img class="control-icon" src="images/icon_pause.png" onclick="app.pauseGame()">
        <img class="control-icon" src="images/icon_stop.png" onclick="app.exitGame()">
    </div>

    <!-- Modal -->
    <div id="modal-mask" class="modal-mask">
        <div class="modal-content">
            <div class="modal-title" id="modal-title">Ê†áÈ¢ò</div>
            <div class="modal-body" id="modal-body">ÂÜÖÂÆπ</div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="app.closeModal()">ÂèñÊ∂à</button>
                <button class="modal-btn confirm" id="modal-confirm-btn">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

</div>

<!-- ÂºïÂÖ•Â§ñÈÉ®ËØçÂ∫ì -->
<script src="words.js"></script>

<script>
// -----------------------------------------------------------
// ‰ª•‰∏ãÊòØÊ∏∏ÊàèÈÄªËæë‰ª£Á†Å
// -----------------------------------------------------------

const ROLE_CONFIG = {
    4: { seer: 1, wolf: 1, villager: 2 },
    5: { seer: 1, wolf: 1, villager: 3 },
    6: { seer: 1, wolf: 1, villager: 4 },
    7: { seer: 1, wolf: 2, villager: 4 },
    8: { seer: 1, wolf: 2, villager: 5 },
    9: { seer: 1, wolf: 2, villager: 6 },
    10: { seer: 1, wolf: 2, villager: 7 }
};
const FIXED_SLOTS_DEF = [
  { type: 'seer', name: 'ÂÖàÁü•', img: 'images/seer.png' },
  { type: 'wolf', name: 'Áãº‰∫∫', img: 'images/wolf.png' },
  { type: 'wolf', name: 'Áãº‰∫∫', img: 'images/wolf.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' },
  { type: 'villager', name: 'ÊùëÊ∞ë', img: 'images/villager.png' }
];
const DIFFICULTY_OPTS = [
    { label: "ÁÆÄÂçï", key: "SIMPLE" }, { label: "ÊôÆÈÄö", key: "NORMAL" },
    { label: "‰∏≠Á≠â", key: "MEDIUM" }, { label: "Âõ∞Èöæ", key: "HARD" }, { label: "Âú∞Áã±", key: "HELL" }
];
const TIMER_OPTS = [4, 5, 6, 7, 8];

// üåü Èü≥È¢ëÊéßÂà∂ÔºöÂåÖÂê´È¢ÑÁÉ≠ÈÄªËæë (Warm Up) Ëß£ÂÜ≥ iOS ‰∏çÊí≠ÊîæÈóÆÈ¢ò
const AudioController = {
    ctx: {},
    currentAudio: null,
    tickFadeInterval: null,
    tickStopTimeout: null,
    isWarmedUp: false,

    init: function() {
        const files = ['click', 'paper', 'pop', 'night_start', 'mayor_identity', 'mayor_pick', 'seer_open', 'seer_close', 'wolf_open', 'wolf_close', 'day_break', 'sfx_tick_tock', 'voice_assassinate', 'sfx_win_werewolf', 'sfx_win_seer', 'sfx_win_villager', 'game_resume'];
        files.forEach(f => {
            this.ctx[f] = new Audio(`audio/${f}.mp3`);
            // È¢ÑÂä†ËΩΩÔºå‰ΩÜ‰∏çËá™Âä®Êí≠Êîæ
            this.ctx[f].preload = 'auto';
            if(f === 'sfx_tick_tock') this.ctx[f].loop = true;
        });
    },

    // üåü Ê†∏ÂøÉÔºöÂú®Áî®Êà∑ÁÇπÂáª‚ÄúÂºÄÂßãÊ∏∏Êàè‚ÄùÊó∂ÔºåÊääÊâÄÊúâÈü≥È¢ëÂø´ÈÄüÈùôÈü≥Êí≠Êîæ‰∏ÄÈÅçÔºåËé∑ÂæóiOSÊí≠ÊîæÊùÉÈôê
    warmUp: function() {
        if (this.isWarmedUp) return;
        console.log("Warming up audio for iOS...");
        Object.keys(this.ctx).forEach(key => {
            const audio = this.ctx[key];
            audio.volume = 0; // ÈùôÈü≥
            const p = audio.play();
            if (p !== undefined) {
                p.then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = 1; // ÊÅ¢Â§çÈü≥Èáè
                }).catch(e => console.log("Warm up skipped for", key));
            }
        });
        this.isWarmedUp = true;
    },

    play: function(name) {
        if (!this.ctx[name]) return;
        // ÊâìÊñ≠ÈùûÊª¥Á≠îÂ£∞ÁöÑÂÖ∂‰ªñÈü≥È¢ë
        if (this.currentAudio && this.currentAudio !== this.ctx[name] && name !== 'sfx_tick_tock') {
            this.currentAudio.pause();
            this.currentAudio.currentTime = 0;
        }
        // Â¶ÇÊûúÊòØÊª¥Á≠îÂ£∞ÔºåÂçïÁã¨Â§ÑÁêÜ
        if (name === 'sfx_tick_tock') {
            this.playTickFade();
            return;
        }

        this.ctx[name].currentTime = 0;
        this.ctx[name].volume = 1;
        
        // Â∞ùËØïÊí≠ÊîæÔºåÊçïËé∑ÈîôËØØ
        const playPromise = this.ctx[name].play();
        if (playPromise !== undefined) {
            playPromise.catch(e => console.log(`Audio [${name}] play failed:`, e));
        }
        
        this.currentAudio = this.ctx[name];
        if (navigator.vibrate) navigator.vibrate(50);
    },
    stop: function(name) {
        if (!this.ctx[name]) return;
        this.ctx[name].pause();
        this.ctx[name].currentTime = 0;
    },
    // üåü ‰øÆÂ§çÔºöÊª¥Á≠îÂ£∞ 5ÁßíÊ∑°Âá∫
    playTickFade: function() {
        const audio = this.ctx['sfx_tick_tock'];
        if(!audio) return;
        
        // ÂÅúÊ≠¢‰πãÂâçÁöÑÊ∑°Âá∫
        this.stopTick();

        audio.volume = 1;
        audio.currentTime = 0;
        const p = audio.play();
        if (p !== undefined) p.catch(e => console.log("Tick sound fail:", e));

        // 5ÁßíÂêéÂºÄÂßãÊ∑°Âá∫
        this.tickStopTimeout = setTimeout(() => {
            let vol = 1;
            this.tickFadeInterval = setInterval(() => {
                vol -= 0.1; // 0.1s Âáè‰∏ÄÊ¨°
                if (vol <= 0) {
                    vol = 0;
                    clearInterval(this.tickFadeInterval);
                    audio.pause();
                }
                try { audio.volume = vol; } catch(e){}
            }, 200);
        }, 5000);
    },
    stopTick: function() {
        const audio = this.ctx['sfx_tick_tock'];
        if(this.tickFadeInterval) clearInterval(this.tickFadeInterval);
        if(this.tickStopTimeout) clearTimeout(this.tickStopTimeout);
        if(audio) {
            audio.pause();
            audio.currentTime = 0;
        }
    }
};

const App = {
    state: { playerCount: 4, difficultyIdx: 1, timerIdx: 1, gameDuration: 300, candidates: [], targetWord: '', timer: null, paused: false, currentPhase: 'SETUP' },
    init: function() { AudioController.init(); this.renderSetup(); },
    changeCount: function(delta) {
        let n = this.state.playerCount + delta;
        if (n >= 4 && n <= 10) { this.state.playerCount = n; AudioController.play('click'); this.renderSetup(); }
    },
    toggleDifficulty: function() { this.state.difficultyIdx = (this.state.difficultyIdx + 1) % DIFFICULTY_OPTS.length; AudioController.play('paper'); this.renderSetup(); },
    toggleTimer: function() { this.state.timerIdx = (this.state.timerIdx + 1) % TIMER_OPTS.length; AudioController.play('pop'); this.renderSetup(); },
    renderSetup: function() {
        document.getElementById('player-count').innerText = this.state.playerCount + '‰∫∫';
        document.getElementById('difficulty-text').innerText = 'ËØçÊ±á: ' + DIFFICULTY_OPTS[this.state.difficultyIdx].label;
        document.getElementById('timer-text').innerText = 'Êó∂Èó¥: ' + TIMER_OPTS[this.state.timerIdx] + 'ÂàÜ';
        const config = ROLE_CONFIG[this.state.playerCount];
        let currentCounts = { seer: 0, wolf: 0, villager: 0 };
        let html = '';
        FIXED_SLOTS_DEF.forEach((slot) => {
            const maxAllowed = config[slot.type] || 0;
            let isActive = currentCounts[slot.type] < maxAllowed;
            if (isActive) currentCounts[slot.type]++;
            html += `<div class="role-item ${isActive?'active':'inactive'}"><div class="avatar-circle"><img class="avatar-icon" src="${slot.img}"></div><div class="role-name">${slot.name}</div></div>`;
        });
        document.getElementById('setup-grid').innerHTML = html;
        document.getElementById('config-summary').innerText = `ÈÖçÁΩÆ: ÂÖàÁü•${config.seer} Áãº‰∫∫${config.wolf} ÊùëÊ∞ë${config.villager}`;
    },
    switchPanel: function(panelId) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(panelId).classList.add('active');
        document.getElementById('game-bottom-bar').style.display = (panelId === 'panel-mayor-pick' || panelId === 'panel-game') ? 'flex' : 'none';
        this.state.currentPhase = panelId === 'panel-game' ? 'GAME' : panelId.replace('panel-', '').toUpperCase();
    },
    startGame: function() {
        // üåü ÂÖ≥ÈîÆÔºöÁî®Êà∑ÁÇπÂáªÂºÄÂßãÊó∂ÔºåÈ¢ÑÁÉ≠ÊâÄÊúâÈü≥È¢ë
        AudioController.warmUp();

        const key = DIFFICULTY_OPTS[this.state.difficultyIdx].key;
        if(!window.WORD_BANK) { alert("ËØçÂ∫ìÂä†ËΩΩÂ§±Ë¥•"); return; }
        const pool = window.WORD_BANK[key] || window.WORD_BANK['NORMAL'];
        this.state.candidates = [...pool].sort(() => 0.5 - Math.random()).slice(0, 6);
        this.state.gameDuration = TIMER_OPTS[this.state.timerIdx] * 60;
        
        this.switchPanel('panel-buffer'); 
        AudioController.play('night_start');
        setTimeout(() => { this.switchPanel('panel-mayor-id'); AudioController.play('mayor_identity'); }, 5000);
    },
    selectIdentity: function(type, el) {
        document.querySelectorAll('.id-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
        setTimeout(() => { this.renderWordPick(); this.switchPanel('panel-mayor-pick'); AudioController.play('mayor_pick'); }, 500);
    },
    renderWordPick: function() {
        let html = '';
        this.state.candidates.forEach((w, idx) => {
            html += `<div class="word-card" onclick="app.pickWord(${idx}, this)"><div class="card-text">${w.word}</div><div class="card-category">${w.category}</div></div>`;
        });
        document.getElementById('word-list').innerHTML = html;
    },
    pickWord: function(idx, el) {
        this.state.targetWord = this.state.candidates[idx].word;
        document.querySelectorAll('.word-card').forEach(b => b.classList.remove('card-selected'));
        el.classList.add('card-selected');
        setTimeout(() => { this.runNightSequence(); }, 500);
    },
    async runNightSequence() {
        this.switchPanel('panel-night');
        const setStatus = (t) => { document.getElementById('night-status-text').style.display='block'; document.getElementById('night-word-container').style.display='none'; document.getElementById('night-status-text').innerText=t; };
        const setWord = () => {
            document.getElementById('night-status-text').style.display='none'; document.getElementById('night-word-container').style.display='block';
            document.querySelectorAll('.target-word').forEach(e => { e.style.transition='none'; e.style.opacity='1'; e.innerText=this.state.targetWord; });
        };
        const fadeOut = () => { 
            document.querySelectorAll('.target-word').forEach(e => { 
                void e.offsetWidth;
                e.style.transition='opacity 2s ease-out'; 
                e.style.opacity='0'; 
            }); 
        };
        const wait = (ms) => new Promise(r => setTimeout(r, ms));
        
        setStatus("ÂÖàÁü•ËØ∑ÁùÅÁúº"); AudioController.play('seer_open'); await wait(2500);
        setWord(); await wait(5000); fadeOut(); await wait(2000);
        setStatus("ÂÖàÁü•ËØ∑Èó≠Áúº"); AudioController.play('seer_close'); await wait(3000);
        setStatus("Áãº‰∫∫ËØ∑ÁùÅÁúº"); AudioController.play('wolf_open'); await wait(2500);
        setWord(); document.querySelectorAll('.target-word').forEach(e => e.style.opacity = 1);
        await wait(5000); fadeOut(); await wait(2000);
        setStatus("Áãº‰∫∫ËØ∑Èó≠Áúº"); AudioController.play('wolf_close'); await wait(3000);
        setStatus("Â§©‰∫Æ‰∫ÜÔºÅ"); AudioController.play('day_break'); await wait(2000);
        this.startMainGame();
    },
    startMainGame: function() {
        this.switchPanel('panel-game'); 
        this.state.paused = false; 
        this.updateTimerDisplay();
        AudioController.playTickFade(); 

        if (this.state.timer) clearInterval(this.state.timer);
        this.state.timer = setInterval(() => {
            if(!this.state.paused) { 
                this.state.gameDuration--; 
                this.updateTimerDisplay(); 
                if(this.state.gameDuration <= 0) { 
                    clearInterval(this.state.timer); 
                    this.switchPanel('panel-result'); 
                    AudioController.stopTick();
                } 
            }
        }, 1000);
    },
    updateTimerDisplay: function() {
        let m = Math.floor(this.state.gameDuration / 60).toString().padStart(2, '0');
        let s = (this.state.gameDuration % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').innerText = `${m}:${s}`;
    },
    onWordGuessed: function() { 
        clearInterval(this.state.timer); 
        AudioController.stopTick(); 
        AudioController.play('voice_assassinate'); 
        setTimeout(() => this.switchPanel('panel-result'), 2000); 
    },
    selectWinner: function(type, el) {
        document.querySelectorAll('.winner-item').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');
        let sound = type === 'wolf' ? 'sfx_win_werewolf' : `sfx_win_${type}`;
        AudioController.play(sound);
    },
    resetGame: function() { 
        clearInterval(this.state.timer); 
        AudioController.stopTick(); 
        this.switchPanel('panel-setup'); 
    },
    pauseGame: function() { 
        this.state.paused = true; 
        AudioController.stopTick(); 
        this.showModal('Ê∏∏ÊàèÂ∑≤ÊöÇÂÅú', 'ÁÇπÂáªÁ°ÆÂÆöÁªßÁª≠', 'PAUSE'); 
    },
    exitGame: function() { this.showModal('ÁªìÊùüÊ∏∏Êàè', 'Á°ÆÂÆöËøîÂõûÈ¶ñÈ°µÔºü', 'EXIT'); },
    showModal: function(t, c, type) {
        document.getElementById('modal-title').innerText=t; document.getElementById('modal-body').innerText=c;
        document.getElementById('modal-mask').classList.add('show');
        document.getElementById('modal-confirm-btn').onclick = () => {
            document.getElementById('modal-mask').classList.remove('show');
            if(type==='PAUSE') { 
                this.state.paused = false; 
                AudioController.play('game_resume'); 
                // ÊÅ¢Â§çÊ∏∏ÊàèÊó∂ÈáçÊñ∞Êí≠ÊîæÊª¥Á≠îÂ£∞ÔºàÂ¶ÇÊûúËøòÊ≤°ÁªìÊùüÔºâ
                 if(this.state.currentPhase === 'GAME') {
                     AudioController.playTickFade();
                 }
            }
            else { this.resetGame(); }
        };
    },
    closeModal: function() { document.getElementById('modal-mask').classList.remove('show'); }
};

window.app = App;
window.onload = () => App.init();
</script>
</body>
</html>